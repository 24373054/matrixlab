#!/bin/bash
# Matrix Lab 网站一键停止脚本

SERVICE_NAME="nginx"
LOG_FILE="/var/log/matrixlab-website-control.log"

# 确保日志文件存在且可写
sudo touch $LOG_FILE
sudo chmod 644 $LOG_FILE

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━" | tee -a $LOG_FILE
echo "  🛑 正在停止 Matrix Lab 网站服务..." | tee -a $LOG_FILE
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━" | tee -a $LOG_FILE
echo "停止时间: $(date)" | tee -a $LOG_FILE
echo "" | tee -a $LOG_FILE

# 检查服务状态
if systemctl is-active --quiet $SERVICE_NAME; then
    echo "尝试停止 Nginx 服务..." | tee -a $LOG_FILE
    sudo systemctl stop $SERVICE_NAME >> $LOG_FILE 2>&1
    
    # 等待服务停止
    sleep 1
    
    # 再次检查状态
    if ! systemctl is-active --quiet $SERVICE_NAME; then
        echo "✅ Nginx 服务已成功停止！" | tee -a $LOG_FILE
        echo "" | tee -a $LOG_FILE
        echo "⚠️  警告：网站现在无法访问。" | tee -a $LOG_FILE
        echo "要重新启动网站，请运行: ./start" | tee -a $LOG_FILE
        echo "" | tee -a $LOG_FILE
    else
        echo "❌ Nginx 服务停止失败！" | tee -a $LOG_FILE
        echo "" | tee -a $LOG_FILE
        echo "请检查日志获取更多信息：" | tee -a $LOG_FILE
        echo "  sudo journalctl -u nginx --since \"5 minutes ago\"" | tee -a $LOG_FILE
        echo "" | tee -a $LOG_FILE
    fi
else
    echo "⚠️  Nginx 服务未在运行。" | tee -a $LOG_FILE
    echo "无需停止。" | tee -a $LOG_FILE
    echo "" | tee -a $LOG_FILE
fi

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━" | tee -a $LOG_FILE
echo "操作完成。" | tee -a $LOG_FILE
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━" | tee -a $LOG_FILE

